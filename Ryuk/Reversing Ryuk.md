Hello World, This Will Probably be My First Malware Report Where I will Reverse Ryuk Ransomware. So Before Getting into Technical Analysis and Reverse Engineering I will Provide Some Introduction to Ryuk. So The Typical Attack Flow of Ryuk is as Follows:

1- An maldoc Contains a malicious macro that will execute PowerShell. 

2- The PowerShell Command then Downloads Emotet Banking Trojan. 

3- Emotet Then Downloads TrickBot 

4- As A Typical Lateral Movement Activity TrickBot Downloads Ryuk 

5- Ryuk Then Tries to Encrypt all the Network Hosts 

Who Created It ? 
--------------------

So Attribution is Hard However From What I have Read Threat Intel Researches Suggest that it belongs to the Authors of HERMES which is a Ransomware first was detected in October 2017 was then arrtributed to an APT Group Called Lazarus Group. 

![Image of Yaktocat](https://1.bp.blogspot.com/-8vPh0iWPH64/X5x4JKdU96I/AAAAAAAAAw4/TyYFVhmVC14g5q1G4FdQHEdD1MvM2XMggCLcBGAsYHQ/w339-h400/330px-Cartel_de_la_orden_de_captura_de_Park_Jin_Hyok.png)

In Depth Reversing:
===================

- I Used a Combination of Cutter, IDA and x64 dbg to reverse this malware so nvm xD

- When Executing the Sample It Drops a Copy From its Self and Execute it using "8 lan" Command. 

![Image of Yaktocat](https://1.bp.blogspot.com/-IFFpq8SNgWc/X58YS_IKO8I/AAAAAAAAA0I/mjXjqekwURgyw8W5fUqHe-pP0Uov7tbWwCLcBGAsYHQ/s320/ryukcopy.PNG)

By Static Code Analysis it Concats ".exe" to the name of the dropped file and executes it using ShellExecute passing a param "8 lan" to it 

![exe](https://user-images.githubusercontent.com/68482847/98047212-3d450c00-1e34-11eb-9708-d1d7fee0c779.PNG)
![ddd](https://user-images.githubusercontent.com/68482847/98047210-3c13df00-1e34-11eb-8f0f-b4b830b66745.PNG)

- The Name of the Dropped Exe are Seven Random Charachters. 
- The Malware Injects Into 4 Process taskeng.exe, host.exe, dwm.exe, ctfmon.exe
- It Ecrypts the Files using "RYK" Extension
- The Malware Deletes its Shadow Copies Using:
        
        [+] cmd /c "WMIC.exe shadowcopy delet
        [+] vssadmin.exe Delete Shadows /all /quiet
  
 ![shadow](https://user-images.githubusercontent.com/68482847/98095723-98f2b200-1e93-11eb-88ac-26216158550d.PNG)

As You Can See a Typo Found in the First Command The Author Missed 'e' in delete. 

Deleting the Dropper:
=======================

It First Passes the path of the dropper so it will further delete. 

![cmd](https://user-images.githubusercontent.com/68482847/98044076-fc96c400-1e2e-11eb-90f8-da3d7e59e4ce.PNG)
![delete](https://user-images.githubusercontent.com/68482847/98044083-fe608780-1e2e-11eb-98a6-42067c619202.PNG)

The Return Value of GetCommandLineA is Stored in EAX which then passed to CommandLineToArgvW. And at last It Calls to DeleteFile to delete the Dropper. 

API Resolving:
==============

Ryuk Uses GetProcAddress and LoadLibraryA to Resolve Its APIs 

![lll](https://user-images.githubusercontent.com/68482847/98049704-e7269780-1e38-11eb-930e-82cb6d10fd92.PNG)

And By Using the Debugger: 

![debug](https://user-images.githubusercontent.com/68482847/98101808-63ea5d80-1e9b-11eb-9bff-0414a1c70d64.PNG)

Privilege Escalation:
======================

Ryuk Escalates Privilege by Modifying the Access Token PROCESS_ALL_ACCESS

![escal](https://user-images.githubusercontent.com/68482847/97906308-17dcd300-1d4c-11eb-993c-f96d25ed1d40.PNG)

![g](https://user-images.githubusercontent.com/68482847/97907791-773be280-1d4e-11eb-9ce9-f46d386f5ec1.PNG)

According to MSDN The LookupPrivilegeValue function retrieves the locally unique identifier (LUID) used on a specified system to locally represent the specified privilege name.
It Takes 3 Parameters lpSystemName, lpName, lpLuid. What We Care About is the Second Here the Second Param is The Name of The Privilege Looked up In this Case its "
"SeDebugPrivilege" this is used to inspect and Modify the memory of other process. This Will Be Used For Process Injection. 

Persistence:
============

Ryuk Acheives Persistence by Adding the Path of the malware under /Run Key In the Registry Makes it Run Every Time the User logs In It uses this Command 

REG  ADD "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "svchos" /t REG_SZ /d "C:\Users\admin\AppData\Local\Temp\860e50.exe" /f

Process Injection:
===================
First It Opens a Process with ACCESS_RIGHT 

![2](https://user-images.githubusercontent.com/68482847/98091239-cb99ac00-1e8d-11eb-9e8f-95eef7c03381.PNG)

Then It Allocates Memory in the Target Process 

![virtualAlloc](https://user-images.githubusercontent.com/68482847/98091247-ce949c80-1e8d-11eb-9cea-acfb95c9b345.PNG)

Next it Writes injects its Self using WriteProcessMemory and Creates a Thread to run the injected code 

![write](https://user-images.githubusercontent.com/68482847/98091341-fbe14a80-1e8d-11eb-8d81-a43069490721.PNG)

Following with the debugger we can see the exectuable in the memory dump 

![dump](https://user-images.githubusercontent.com/68482847/98093347-7a3eec00-1e90-11eb-923a-2131c6ba3e46.PNG)

Encryption:
===========
Ryuk Uses AES Encryption it utilizes the CryptoAPI by Microsoft 

![aes](https://user-images.githubusercontent.com/68482847/98181885-127ab680-1f0d-11eb-92b4-e92622168f28.PNG)

Its Uses:
---------
[+] CryptEncrypt 

[+] CryptGenKey 

[+] CryptDecrypt 

[+] CryptAquireContextW

[+] CryptDestroyKey 

[+] CryptDeriveKey


Relation to HERMES:
====================

Yara Rule:
===========

You Can Find My YARA Rule Here [Ryuk](https://github.com/astrovax/MalwareSlaying/blob/main/Ryuk/Ryuk.yara)

IOCS:
=====
SHA256: 40b865d1c3ab1b8544bcf57c88edd30679870d40b27d62feb237a19f0c5f9cd1

SHA1: AD11ED52AB33AD05EB9B1E9ADE134CA1348ACC81

MD5: 484a2bcb1335ac97ee91194f4c0964bc

IPs: 192.168.100.184

![Image of Yaktocat](https://1.bp.blogspot.com/-r6y1mBGj0kY/X58c7J4pcSI/AAAAAAAAA0g/RLdqXLTF97M8schlrfzTBaSsZHGaHmyLACLcBGAsYHQ/w400-h269/ip.PNG) 

Disclaimer: I am not sure by this location this is just the result of [ViewDNS](https://viewdns.info/iplocation/?ip=192.168.100.184)


TTPs:
=====

[+] Command-Line Interface [T1059](https://attack.mitre.org/techniques/T1059)

[+] Execution through API  [T1106](https://attack.mitre.org/techniques/T1106) 

[+] Service Execution   [T1035](https://attack.mitre.org/techniques/T1035)    

[+] Registry Run Keys / Startup Folder  [T1060](https://attack.mitre.org/techniques/T1060)

[+] Process Injection   [T1055](https://attack.mitre.org/techniques/T1055) 

[+] Disabling Security Tools [T1089](https://attack.mitre.org/techniques/T1089)

[+] File Permissions Modification [T1222](https://attack.mitre.org/techniques/T1222)

[+] Modify Registry [T1112](https://attack.mitre.org/techniques/T1112)

[+] Process Injection [T1055](https://attack.mitre.org/techniques/T1055)

[+] Query Registry [T1012](https://attack.mitre.org/techniques/T1012)

[+] System Service Discovery  [T1007](https://attack.mitre.org/techniques/T1007)

[+] Inhibit System Recovery  [T1490](https://attack.mitre.org/techniques/T1490)

[+] Access Token Manipulation [T1134](https://attack.mitre.org/techniques/T1134/)

[+] Process Discovery	[T1057](https://attack.mitre.org/techniques/T1057)

[+] Service Stop	[T1489](https://attack.mitre.org/techniques/T1489)

[+] Impair Defenses: Disable or Modify Tools [T1562](https://attack.mitre.org/techniques/T1562)

[+] Data Encrypted for Impact [T1486](https://attack.mitre.org/techniques/T1486)

List of The Commands Executed:
===============================

[+] cmd /c \"WMIC.exe shadowcopy delet\

[+] icacls "C:\*" /grant Everyone:F /T /C /Q

[+] vssadmin.exe Delete Shadows /all /quiet

[+] bcdedit /set {default} recoveryenabled No & bcdedit /set {default}

[+] bootstatuspolicy ignoreallfailures

[+] "C:\Windows\System32\net.exe" stop "audioendpointbuilder" /y

[+] C:\Windows\system32\net1 stop "audioendpointbuilder" /y

[+] "C:\Windows\System32\net.exe" stop "samss" /y

[+] C:\Windows\system32\net1 stop "samss" /y

[+] REG  ADD "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "svchos" /t REG_SZ /d "C:\Users\admin\AppData\Local\Temp\USvoLou.exe" /f

[+] "C:\Windows\System32\cmd.exe" /C REG ADD "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "svchos" /t REG_SZ /d                                  
"C:\Users\admin\AppData\Local\Temp\USvoLou.exe" /f

[+] /C REG DELETE "HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" /v "svchos" /f

RansomNote:
===========

![rrr](https://user-images.githubusercontent.com/68482847/98045593-67e19580-1e31-11eb-8019-60367497e4ee.PNG)

For More Info:
===============

https://n1ght-w0lf.github.io/malware%20analysis/ryuk-ransomware/

https://www.fortinet.com/blog/threat-research/ryuk-revisited-analysis-of-recent-ryuk-attack

https://research.checkpoint.com/2018/ryuk-ransomware-targeted-campaign-break/

https://blog.malwarebytes.com/threat-spotlight/2019/12/threat-spotlight-the-curious-case-of-ryuk-ransomware/

https://www.fireeye.com/blog/threat-research/2019/01/a-nasty-trick-from-credential-theft-malware-to-business-disruption.html

https://www.fireeye.com/blog/threat-research/2020/10/kegtap-and-singlemalt-with-a-ransomware-chaser.html

https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/

https://www.youtube.com/watch?v=CgDtm05qApE

GoodBye!
=========

So That's It Hope You Enjoy It I am a N00b so my mistakes are alot xD so if u have any suggestions for me feel free to dm on twitter [@astrovax](https://twitter.com/astrovax_)
