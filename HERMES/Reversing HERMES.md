Reversing HERMES
----------------

Hello World, In this Article I will be reversing HERMES Ransomware. In my last Report Ryuk I discussed how Ryuk relates to HERMES , so definitely in this Article we will dive deep on How HERMES works. Soo Let's Goo without any further delays. 

Quick Overview:
===============

HERMES is a Ransomare was spread by Spearphising emails. It was first detected in october 2017. Its Arrtributed to lazurus apt group. it has high connections to Ryuk Ransomware and its believed to be that they are written by the same author. As Most Ransomwares it encrypts the files using AES and Encrypts the AES Random Key using RSA. 

In Depth-Reversing:
====================

. HERMES Drops A Copy From its Self under Name "svchosta.exe" in the Temp Folder

![svchosta](https://user-images.githubusercontent.com/68482847/98482530-b5cc1400-220a-11eb-897a-d81c14dd7ae5.PNG)

And It Executes it using this Command 

![s](https://user-images.githubusercontent.com/68482847/98482696-c03add80-220b-11eb-854e-e94492148e0a.PNG)

. Like Most Ransomwares it deletes shadow copies to achieve this it drops a batch file similar to the Ryuk one right ?
![batch](https://user-images.githubusercontent.com/68482847/98482737-0abc5a00-220c-11eb-96db-0932a44fe3e4.PNG)

And it Execute it using this command 

![executebatch](https://user-images.githubusercontent.com/68482847/98482869-ef9e1a00-220c-11eb-971f-0f293682aa64.PNG)

Unpacking and API Resolving:
-----------------------------

HERMES Allocates a seciton in memory for the unpacked PE File this Technique is called Self Injection. The Way this Technique works is like this cc to OAlabs for this image but actually I found it really explain the technqiue 

![rrr](https://user-images.githubusercontent.com/68482847/98729051-fe1e3a00-23a2-11eb-8592-ce3ab1cb88de.PNG)

What we need to do is to fire up the debugger and put 2 break points on:
    
    [+] VirtualAlloc
    
    [+] VirtualProtect

When breaking on VirtualAlloc() Press Execute till return. The Return value of VirtualAlloc() is stored in EAX so click on it and follow in dump. Now the dump is empty 

![unpack1](https://user-images.githubusercontent.com/68482847/98608666-5f3b0480-22f4-11eb-891f-1ec52d0e2560.PNG)

Now Press F9 Again 

![nicepe](https://user-images.githubusercontent.com/68482847/98608745-88f42b80-22f4-11eb-88d9-895f9e1a145b.PNG)

Yay! A Nice PE File. Now Just follow in memory map and dump the file :)

Opening the file in PE Studio Click on Imports and Sadly there are just 5 imports :( so there must be a function that resolves those imports. 

![imports](https://user-images.githubusercontent.com/68482847/98608954-f607c100-22f4-11eb-90e8-9a41eb529eb8.PNG)

Now let's Fire Up IDA. Go to the imports Click "X" on LoadLibraryA to see where its called. 

![load](https://user-images.githubusercontent.com/68482847/98615473-6ddce800-2303-11eb-95b8-608c019ea63c.PNG)

Go for the First One.. 

And Bingo We Found it :)

![reee](https://user-images.githubusercontent.com/68482847/98615573-a381d100-2303-11eb-9911-a3127f7e3e5c.PNG)

So It looks like its passing the API to a decryption or deobfsucation function. Now Just take this Address and and set a Break Point on it. when u break on it click execute till return. U may found sth! ECX holds our API.  

![ecx](https://user-images.githubusercontent.com/68482847/98615734-f9ef0f80-2303-11eb-9847-09f9b4fed3e7.PNG)

So Now Right Click on ECX and Follow in Dump U must find all the APIs

![apiresolved1](https://user-images.githubusercontent.com/68482847/98615790-14c18400-2304-11eb-8f71-5bc845c24161.PNG)

Now we have 3 choices first one is to dump the file using scylla, second is to rename the imports manually and third is to write a script. will leave it as an excercise for u ;)

Mutex Creation:
---------------

HERMES Creates a Mutex with the name "tech". As U Can See the APIs related to mutex's are dynamiclly resolved. 

![createmutex](https://user-images.githubusercontent.com/68482847/98949920-012f3c80-2501-11eb-82e1-92e00a7f45bd.PNG)

U may ask what is a mutex and why does the malware uses it ?. So let me explain. First What is a Mutex is an object that allows mutliple threads to share the same resource but in order. complicated right ? so let me explain why we need mutexes, when u have two threads sharing the same resource say if the Thread "A" Reads From this Resource and Thread "B" Writes to this resource this resource maybe anything like a file for example. This Behavior is Called "Race Condition" this must not happens because if Thread "B" Writes to the File for ex Thread "A" will get corrupted data. So we need a Mechanism to scheduale this behavior and that's what a mutex is a mutex aquires a lock for the Thread this says oh ok now Thread "A" for ex u have the ability to read or write to the file or any other operation and Thread "B" Cannot Do any operation on that file before Thread "A" Releases This Lock or Mutex and It will be given to Thread "B". ok but u may also ask so also how all of this story relates to malware. ok malware uses mutexes for mutiple things one of them is not infecting the host twice. 

Language Checks:
----------------

HERMES Checks for the System language. Every language on this planet has a code this code is just a number for example 0409 is the code for english. The code of the system language can be found under the a registry key:

    [+] Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Nls\Language
 
![language](https://user-images.githubusercontent.com/68482847/99127027-fe6f3d00-260f-11eb-95dd-0ac4d4c0c0bf.PNG)

As u can see the third value is the system language code. now lets see how it utlizes this feature. 

![Regopenkey](https://user-images.githubusercontent.com/68482847/99127109-2e1e4500-2610-11eb-9baa-0273b2dd7314.PNG)

It opens the Registry key I mentioned above and then it queries the value of InstallLanguage and Compares it with three values:
      
      [+] 0419 --> Russian
      [+] 0422 --> Ukrainian
      [+] 0423 --> Belarusian
      
 And if it matches it exits the process (malware) using ExitProcess. 
 
![lll](https://user-images.githubusercontent.com/68482847/99127414-ee0b9200-2610-11eb-848e-e12dc3bc10ef.PNG)
 
 U may ask why this is important well this might be important in targetted attacks so it looks like it didn't want to target those countries. so luckily these three countires won't get infected ;). Read this for more info [Malware Trying to Avoid Some Contries](https://www.welivesecurity.com/2009/01/15/malware-trying-to-avoid-some-countries/)
 
Drive Type Checking:
--------------------

HERMES Does Some Drive Checking using GetLogicalDrives() and GetDriveType() 

![drive](https://user-images.githubusercontent.com/68482847/99128328-2c09b580-2613-11eb-9929-6e9f5e7a535c.PNG)

It First Gets the Drives on the Systems and Then Calls to GetDriveType If Return value of it is 5 means its (CD-ROM) it skips it. 

Percistance:
-------------
HERMES Achieves Percistance by Dropping the "start.bat" batchfile in the startup folder to start the malware every time the computer starts why ?? doesn't it encrypt the files and everything is fine ? ok but what if it missed a file or if u have new files 

![start](https://user-images.githubusercontent.com/68482847/98482739-0d1eb400-220c-11eb-929a-d331fe652306.png)

It Drops this batch file in the StartUp Folder. The StartUp Folder in it the programs that are executed automaticly every time the user logs in or when the computer starts. 

![startmenu](https://user-images.githubusercontent.com/68482847/98483110-80292a00-220e-11eb-97cf-2c44375846f9.PNG)

And U Simply Can Disable this File or simply delete it from the start folder. 

Encryption:
-----------

HERMES Encrypts The Files using AES-256 Algorithm and Encrypts the AES Random Key with RSA, And It utlizes the Windows CryptAPI. 

It uses:
--------

    [+] CryptEncrypt 
    [+] CryptGenKey 
    [+] CryptExportKey 
    [+] CryptAcquireContextW

. It Drops two Files used for Encryption "PUBLIC" and "UNIQUE_ID_DONT_REMOVE". 

![files](https://user-images.githubusercontent.com/68482847/98483166-d8f8c280-220e-11eb-9b60-b319344ddf57.PNG)

The First one is a Public RSA Blob. These Blobs are used to store RSA Public Keys. 

![lll](https://user-images.githubusercontent.com/68482847/98485339-727ba080-221e-11eb-9fd5-33cb6d014408.PNG)

And the last one is the private key which means its for the attacker only and its encrypted. Take alook at the first 8 bytes from offset 0 to 7 actually these bytes has great meaning the 0x7 means that its a private key blob, 0x2 is the blob version and 0xA400 is the algorithm so this will tell that its RSA or any other algorithm for our case its RSA. 

![privateRSA](https://user-images.githubusercontent.com/68482847/98485412-dc944580-221e-11eb-998a-89b33cc7ed68.PNG)

HERMES Uses "HERMES" Marker at the end of the file to identify if the file is encrypted or not 

![marker](https://user-images.githubusercontent.com/68482847/98607705-63662280-22f2-11eb-8180-e886277f5c35.PNG)

by CodeAnalysis it uses ReadFile and Checks for the marker as shown here 

![checkformarker](https://user-images.githubusercontent.com/68482847/99398152-b04a8a00-28ec-11eb-93af-2205d65e0def.PNG)

It Generates a AES-256 Key 

![gen](https://user-images.githubusercontent.com/68482847/99398545-3bc41b00-28ed-11eb-9c06-aaf133cf1d49.PNG)

HERMES Encrypts the File in chunks it reads the files and Encrypts it 1000000 bytes each

![encrypt](https://user-images.githubusercontent.com/68482847/99398867-95c4e080-28ed-11eb-8e76-42fe03ffc22f.PNG)

IOC's:
======

Hashes:
-------      
      [+] MD5:254caeddba73aa4d1bb425c5274176d2 (Packed) 
   
      [+] SHA1:728711076a9e04b5e1e0010045e477d3515356b5
      
      [+] SHA256:a5a0964b1308fdb0aeb8bd5b2a0f306c99997c7c076d66eb3ebcdd68405b1da2
       
      [+] MD5:4f99ef502992d9ef9be6dc4ff27b1e95 (Unpacked)
                 
Dropped Files:
---------------

      [+] svchosta.exe (main payload) 
      
      [+] UNIQUE_ID_DONT_REMOVE (Private RSA Key) 
      
      [+] PUBLIC (Public RSA Key)
      
      [+] windows.bat (deletes shadow copies)
      
      [+] start.bat (starts the malware everytime the computer starts)
      
      [+] DECRYPT_INFORMATION.html (Ransomware Note) 
            

TTP's:
------
   [+] Command-Line Interface [T1059](https://attack.mitre.org/techniques/T1059)

   [+] Registry Run Keys / Startup Folder  [T1060](https://attack.mitre.org/techniques/T1060)

   [+] Data Encrypted for Impact [T1486](https://attack.mitre.org/techniques/T1486)

   [+] Execution through API  [T1106](https://attack.mitre.org/techniques/T1106) 
   
   [+] Modify Registry [T1112](https://attack.mitre.org/techniques/T1112)

   [+] File Permissions Modification [T1222](https://attack.mitre.org/techniques/T1222)

   [+] Inhibit System Recovery  [T1490](https://attack.mitre.org/techniques/T1490)

   [+] Query Registry [T1012](https://attack.mitre.org/techniques/T1012)

     
Emails: 
-----  
      [+] primary email: pretty040782@gmail.com
      [+] reserve email: pretty040782@keemail.me

Skipped Folders:
---------------

    [+] Windows
    [+] AhnLab
    [+] Chrome
    [+] Microsoft
    [+] Mozilla
    [+] $Recycle.Bin
    [+] WINDOWS 

TTP's:
------
   [+] Command-Line Interface [T1059](https://attack.mitre.org/techniques/T1059)

   [+] Registry Run Keys / Startup Folder  [T1060](https://attack.mitre.org/techniques/T1060)

   [+] Data Encrypted for Impact [T1486](https://attack.mitre.org/techniques/T1486)

   [+] Execution through API  [T1106](https://attack.mitre.org/techniques/T1106) 
   
   [+] Modify Registry [T1112](https://attack.mitre.org/techniques/T1112)

   [+] File Permissions Modification [T1222](https://attack.mitre.org/techniques/T1222)

   [+] Inhibit System Recovery  [T1490](https://attack.mitre.org/techniques/T1490)

   [+] Query Registry [T1012](https://attack.mitre.org/techniques/T1012)
      
Ransomware Note:
================

![herm](https://user-images.githubusercontent.com/68482847/98483549-f1b6a780-2211-11eb-9db9-1c388d24f0f8.PNG)

Dump Shots:
===========

Yeah It was the dumpest malware I have ever analyzed xD

![ll](https://user-images.githubusercontent.com/68482847/99396381-58ab1f00-28ea-11eb-85a2-cd194937cc22.PNG)

![cangetvalue](https://user-images.githubusercontent.com/68482847/99396551-8f813500-28ea-11eb-95d3-8d479a2e5a6b.PNG)

And There is more xD

References:
===========
   https://blog.malwarebytes.com/threat-analysis/2018/03/hermes-ransomware-distributed-to-south-koreans-via-recent-flash-zero-day/

   https://app.any.run/tasks/29fd99e4-7087-45bc-8105-2746d44a46d9
   
   https://analyze.intezer.com/analyses/4c6a208b-d5b6-4954-b144-9254d7dfc5ac
   
   https://www.youtube.com/watch?v=WthvahlAYFY&t=225s
   
   https://www.welivesecurity.com/2009/01/15/malware-trying-to-avoid-some-countries/
   
   https://www.autoitscript.com/autoit3/docs/appendix/OSLangCodes.htm
   
   https://www.sans.org/blog/looking-at-mutex-objects-for-malware-discovery-indicators-of-compromise/


GoodBye!
========
So That's It Hope u Enjoy and Thanks for AXIAL For Letting me in the team we will be making more inshallah don't forget to follow me [@astrovax](https://twitter.com/astrovax_) and [@AXI4L](https://twitter.com/AXI4L) 
